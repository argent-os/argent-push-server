<!DOCTYPE html>

<html>
<head>
  <title>user-controller.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="secrets.html">
                  secrets.js
                </a>
              
                
                <a class="source" href="user-controller.html">
                  user-controller.js
                </a>
              
                
                <a class="source" href="express-jwt-auth.html">
                  express-jwt-auth.js
                </a>
              
                
                <a class="source" href="logger.html">
                  logger.js
                </a>
              
                
                <a class="source" href="mailer.html">
                  mailer.js
                </a>
              
                
                <a class="source" href="userhelper.html">
                  userhelper.js
                </a>
              
                
                <a class="source" href="utils.html">
                  utils.js
                </a>
              
                
                <a class="source" href="user.html">
                  user.js
                </a>
              
                
                <a class="source" href="account-test.html">
                  account-test.js
                </a>
              
                
                <a class="source" href="config-test.html">
                  config-test.js
                </a>
              
                
                <a class="source" href="mailer-test.html">
                  mailer-test.js
                </a>
              
                
                <a class="source" href="test-server.html">
                  test-server.js
                </a>
              
                
                <a class="source" href="test.html">
                  test.js
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>user-controller.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> User        = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../models/user'</span>);
<span class="hljs-keyword">var</span> userHelper  = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../lib/userhelper'</span>);
<span class="hljs-keyword">var</span> utils       = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../lib/utils'</span>);
<span class="hljs-keyword">var</span> mailer      = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../lib/mailer'</span>);
<span class="hljs-keyword">var</span> jwt         = <span class="hljs-built_in">require</span>(<span class="hljs-string">'jwt-simple'</span>);
<span class="hljs-keyword">var</span> _           = <span class="hljs-built_in">require</span>(<span class="hljs-string">'lodash'</span>);
<span class="hljs-keyword">var</span> fs          = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>);
<span class="hljs-keyword">var</span> nconf       = <span class="hljs-built_in">require</span>(<span class="hljs-string">'nconf'</span>);
<span class="hljs-keyword">var</span> moment      = <span class="hljs-built_in">require</span>(<span class="hljs-string">'moment'</span>);
<span class="hljs-keyword">var</span> logger      = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../lib/logger'</span>)();
<span class="hljs-keyword">var</span> request     = <span class="hljs-built_in">require</span>(<span class="hljs-string">'request'</span>);
<span class="hljs-keyword">var</span> Firebase    = <span class="hljs-built_in">require</span>(<span class="hljs-string">'firebase'</span>);

<span class="hljs-keyword">var</span> tokenSecret = process.env.JWT_SECRET;
<span class="hljs-keyword">var</span> facebookSecret   = process.env.FACEBOOK_SECRET;
<span class="hljs-keyword">var</span> ref = <span class="hljs-keyword">new</span> Firebase(process.env.FIREBASE_URL);
<span class="hljs-keyword">var</span> FirebaseTokenGenerator = <span class="hljs-built_in">require</span>(<span class="hljs-string">"firebase-token-generator"</span>);
<span class="hljs-keyword">var</span> tokenGenerator = <span class="hljs-keyword">new</span> FirebaseTokenGenerator(process.env.FIREBASE_SECRET);

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">UserController</span> (<span class="hljs-params">req, res, next</span>) </span>{}

UserController.prototype.register = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, res, next</span>) </span>{
  <span class="hljs-keyword">var</span> data = req.body;
  User.findOne({ email: req.body.email }, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, existingUser</span>) </span>{
        <span class="hljs-keyword">if</span> (existingUser) {
          <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">409</span>).send({ message: <span class="hljs-string">'Email is already taken'</span> });
        }    
        User.findOne({ username: req.body.username }, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, existingUser</span>) </span>{
          <span class="hljs-keyword">if</span>(existingUser) {
            <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">409</span>).send({ message: <span class="hljs-string">'Username is already taken'</span> });
          }</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>console.log(‘registering’);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">var</span> user = <span class="hljs-keyword">new</span> User({
            role: req.body.role,
            username: req.body.username,
            email: req.body.email,
            password: req.body.password
          });
          ref.createUser({
            email: req.body.email,
            password: req.body.password
          }, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">error, userData</span>) </span>{
            <span class="hljs-keyword">if</span> (error) {
              <span class="hljs-built_in">console</span>.log(error);</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>switch (error.code) {
  case “EMAIL_TAKEN”:
    ////console.log(“The new user account cannot be created because the email is already in use.”);
    return res.status(401).send({ message: ‘Access denied: email already taken’ });
    break;
  case “INVALID_EMAIL”:
    return res.status(401).send({ message: ‘Access denied: invalid email’ });
    ////console.log(“The specified email is not a valid email.”);
    break;
  default:
    return res.status(401).send({ message: ‘Access denied: error creating user’ });
    ////console.log(“Error creating user:”, error);
}</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>console.log(userData);
//console.log(“Successfully created user account with uid:”, userData.uid);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            }
          });    
          user.save().then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">var</span> _firebaseToken = tokenGenerator.createToken({ uid: (user._id).toString(), hasTCAccess: <span class="hljs-literal">true</span> });      
              ref.authWithCustomToken(_firebaseToken, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">error, authData</span>) </span>{
                <span class="hljs-keyword">if</span> (error) {</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>console.log(error);
//console.log(“Login Failed!”, error);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                  res.send(<span class="hljs-number">500</span>);                    
                } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>console.log(authData);
//console.log(“Login Succeeded!”, authData);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                  res.send({ token: createJWT(user), auth: authData,  user: user });          
                }
              });         
          });                
       });
    });
};

UserController.prototype.login = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, res, next</span>) </span>{
  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
  User.findOne({ email: req.body.email }, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, user</span>) </span>{
    <span class="hljs-keyword">if</span> (!user) {
      <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">401</span>).send({ message: <span class="hljs-string">'Wrong email and/or password'</span> });
    }
    user.comparePassword(req.body.password, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, isMatch</span>) </span>{
      <span class="hljs-keyword">if</span> (!isMatch) {
        <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">401</span>).send({ message: <span class="hljs-string">'Wrong email and/or password'</span> });
      }
      <span class="hljs-keyword">var</span> _firebaseToken = tokenGenerator.createToken({ uid: (user._id).toString(), hasTCAccess: <span class="hljs-literal">true</span> });
      ref.authWithCustomToken(_firebaseToken, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">error, authData</span>) </span>{
        <span class="hljs-keyword">if</span> (error) {</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>//console.log(“Login Failed!”, error);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          res.send(<span class="hljs-number">500</span>);                    
        } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>//console.log(“Login Succeeded!”, authData);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          res.send({ token: createJWT(user), auth: authData,  user: user });          
        }
      });      
    });
  });
};

UserController.prototype.loginFacebook = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res, next</span>) </span>{
    <span class="hljs-keyword">var</span> accessTokenUrl = <span class="hljs-string">'https://graph.facebook.com/v2.3/oauth/access_token'</span>;
    <span class="hljs-keyword">var</span> graphApiUrl = <span class="hljs-string">'https://graph.facebook.com/v2.3/me'</span>;
    <span class="hljs-keyword">var</span> params = {
      code: req.body.code,
      client_id: req.body.clientId,
      client_secret: facebookSecret,
      redirect_uri: req.body.redirectUri
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Step 1. Exchange authorization code for access token.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    request.get({ url: accessTokenUrl, qs: params, json: <span class="hljs-literal">true</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, response, accessToken</span>) </span>{
      <span class="hljs-keyword">if</span> (response.statusCode !== <span class="hljs-number">200</span>) {
        <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">500</span>).send({ message: accessToken.error.message });
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Step 2. Retrieve profile information about the current user.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      request.get({ url: graphApiUrl, qs: accessToken, json: <span class="hljs-literal">true</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, response, profile</span>) </span>{
        <span class="hljs-keyword">if</span> (response.statusCode !== <span class="hljs-number">200</span>) {
          <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">500</span>).send({ message: profile.error.message });
        }
        <span class="hljs-keyword">if</span> (req.headers.authorization) {
          User.findOne({ facebook: profile.id }, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, existingUser</span>) </span>{
            <span class="hljs-keyword">if</span> (existingUser) {
              <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">409</span>).send({ message: <span class="hljs-string">'There is already a Facebook account that belongs to you'</span> });
            }
            <span class="hljs-keyword">var</span> token = req.headers.authorization.split(<span class="hljs-string">' '</span>)[<span class="hljs-number">1</span>];
            <span class="hljs-keyword">var</span> payload = jwt.decode(token, tokenSecret);
            User.findById(payload.user, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, user</span>) </span>{
              <span class="hljs-keyword">if</span> (!user) {
                <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">400</span>).send({ message: <span class="hljs-string">'User not found'</span> });
              }
              user.facebook = profile.id;
              user.picture = user.picture || <span class="hljs-string">'https://graph.facebook.com/v2.3/'</span> + profile.id + <span class="hljs-string">'/picture?type=large'</span>;
              user.displayName = user.displayName || profile.name;
              user.save(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
                <span class="hljs-keyword">var</span> token = createJWT(user);
                res.send({ token: token, user: user });
              });
            });
          });
        } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Step 3b. Create a new user account or return an existing one.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          User.findOne({ facebook: profile.id }, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, existingUser</span>) </span>{
            <span class="hljs-keyword">if</span> (existingUser) {
              <span class="hljs-keyword">var</span> token = createJWT(existingUser);
              <span class="hljs-keyword">return</span> res.send({ token: token, user: existingUser });
            }
            <span class="hljs-keyword">var</span> user = <span class="hljs-keyword">new</span> User();
            user.facebook = profile.id;
            user.picture = <span class="hljs-string">'https://graph.facebook.com/'</span> + profile.id + <span class="hljs-string">'/picture?type=large'</span>;
            user.displayName = profile.name;
            user.save(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
              <span class="hljs-keyword">var</span> token = createJWT(user);
              res.send({ token: token, user:user });
            });
          });
        }
      });
    });  
}

UserController.prototype.removeAccount = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, res, next</span>) </span>{
  User.remove({_id: req.user._id}, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) </span>{
    <span class="hljs-keyword">if</span> (!err) {
      <span class="hljs-keyword">if</span> (nconf.get(<span class="hljs-string">'removeCallback'</span>)) {
        nconf.get(<span class="hljs-string">'removeCallback'</span>)(req.user._id);
      }
      res.status(<span class="hljs-number">200</span>).send({msg: <span class="hljs-string">'account_removed'</span>});
    }
    <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>logger.error(‘Error removing user account. User id : ‘ + req.user._id);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    }
  });
};

UserController.prototype.editProfile = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, res, next</span>) </span>{
  <span class="hljs-keyword">var</span> data = req.body;</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>req.assert(‘username’, ‘Username must be at least 4 characters long’).len(4);
req.assert(‘email’, ‘Email is not valid’).isEmail();</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> errors = req.validationErrors();
  <span class="hljs-keyword">if</span> (errors) {
    res.status(<span class="hljs-number">400</span>).json(errors);
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }
  userHelper.checkIfUserExists(req.user, data, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">result</span>) </span>{
    <span class="hljs-keyword">if</span> (result === <span class="hljs-string">'user_uniq'</span>) {
      User.findOne({_id: req.user._id}, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, user</span>) </span>{
          <span class="hljs-keyword">if</span> (!user) {</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>logger.info(‘User not found for account update. User id : ‘ + req.user._id);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            res.status(<span class="hljs-number">404</span>).json({msg: <span class="hljs-string">'User not found, could not update'</span>})
            <span class="hljs-keyword">return</span>;
          }
          <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">var</span> updated = [];
            <span class="hljs-keyword">if</span> (user.email !== data.user.email &amp;&amp; data.user.email !=<span class="hljs-literal">null</span>) {
              updated.push(<span class="hljs-string">'email'</span>);
              user.email = data.user.email;
            }
            <span class="hljs-keyword">if</span> (user.role !== data.user.role &amp;&amp; data.user.email !=<span class="hljs-literal">null</span>) {
              updated.push(<span class="hljs-string">'role'</span>);
              user.role = data.user.role;
            }      
            <span class="hljs-keyword">if</span> (user.orgId !== data.orgId &amp;&amp; data.orgId !=<span class="hljs-literal">null</span>) {
              updated.push(<span class="hljs-string">'orgId'</span>);
              user.orgId = data.orgId;
            }      
            <span class="hljs-keyword">if</span> (user.notificationsEnabled !== data.user.notificationsEnabled) {
              updated.push(<span class="hljs-string">'notificationsEnabled'</span>);
              user.notificationsEnabled = data.user.notificationsEnabled;
            }   
            <span class="hljs-keyword">if</span> (user.darkThemeEnabled !== data.user.darkThemeEnabled) {
              updated.push(<span class="hljs-string">'darkThemeEnabled'</span>);
              user.darkThemeEnabled = data.user.darkThemeEnabled;
            }      
            <span class="hljs-keyword">if</span> (user.apiKey !== data.apiKey &amp;&amp; data.apiKey !=<span class="hljs-literal">null</span>) {
              updated.push(<span class="hljs-string">'apiKey'</span>);
              user.apiKey = data.apiKey;
            }     
            <span class="hljs-keyword">if</span> (user.picture !== data.picture &amp;&amp; data.picture !=<span class="hljs-literal">null</span>) {
              updated.push(<span class="hljs-string">'picture'</span>);
              user.picture = data.picture;
            }      
            <span class="hljs-keyword">if</span> (user.name !== data.user.name) {
              updated.push(<span class="hljs-string">'name'</span>);
              user.name = data.user.name;
            }                                                  
            <span class="hljs-keyword">if</span> (user.username !== data.user.username) {
              updated.push(<span class="hljs-string">'username'</span>);
              user.username = data.user.username;
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>if (data.password !== ‘’) {
  updated.push(‘password’);
  user.password = data.password;
}</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (updated.length &gt; <span class="hljs-number">0</span>) {
              user.date_modified = <span class="hljs-built_in">Date</span>.now();
              <span class="hljs-keyword">var</span> out = {
                email: user.email,
                name: user.name,
                username: user.username,
                orgId: user.orgId,
                notificationsEnabled: user.notificationsEnabled,
                darkThemeEnabled: user.darkThemeEnabled,
                apiKey: user.apiKey,
                picture: user.picture,
                role: [user.role]
              };
            }
            <span class="hljs-keyword">else</span> {
              res.status(<span class="hljs-number">200</span>).json({msg: <span class="hljs-string">'Data not modified'</span>});
              <span class="hljs-keyword">return</span>;
            }

            user.save(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) </span>{
              <span class="hljs-keyword">if</span> (err) {</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>logger.error(‘Error updating user account. User id: ‘ + req.user._id + ‘ Err: ‘ + err);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                res.status(<span class="hljs-number">401</span>).json({msg: <span class="hljs-string">'update_error'</span>});
              }
              <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">var</span> newToken = createJWT(user);
                res.json({token: newToken, user: user});
              }
            });
          }
        });
    }
    <span class="hljs-keyword">else</span> {
      res.status(<span class="hljs-number">409</span>).json(result);
    }
  });
};

UserController.prototype.getProfile = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, res, next</span>) </span>{
  <span class="hljs-keyword">var</span> errors = req.validationErrors();
  <span class="hljs-keyword">if</span> (errors) {
    res.status(<span class="hljs-number">400</span>).json(errors);
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }
  User.findById(req.user._id, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, user</span>) </span>{
      <span class="hljs-keyword">if</span> (!user) {</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>logger.info(‘User not found for account update. User id : ‘ + req.user._id);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">return</span>;
      }
      <span class="hljs-keyword">else</span> {
        res.json(user);
        <span class="hljs-keyword">return</span>;
      }
    });
};

UserController.prototype.generateApiKey = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, res, next</span>) </span>{
  <span class="hljs-keyword">var</span> errors = req.validationErrors();
  <span class="hljs-keyword">if</span> (errors) {
    res.status(<span class="hljs-number">400</span>).json(errors);
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }
  User.findById(req.user._id, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, user</span>) </span>{
      <span class="hljs-keyword">if</span> (!user) {</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>logger.info(‘User not found for account update. User id : ‘ + req.user._id);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">return</span>;
      }
      <span class="hljs-keyword">else</span> {
        res.send({ token: createApiKey(user) });        
        <span class="hljs-keyword">return</span>;
      }
    });
};

UserController.prototype.remindPassword = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>) </span>{
  <span class="hljs-keyword">var</span> email = req.body.email;
  <span class="hljs-keyword">var</span> url = req.body.url;
  <span class="hljs-keyword">if</span> (email === <span class="hljs-string">''</span> || !email) {
    res.status(<span class="hljs-number">400</span>).json([{msg: <span class="hljs-string">'Email cannot be empty'</span>, param: <span class="hljs-string">'email'</span>}]);
    <span class="hljs-keyword">return</span>;
  }
  <span class="hljs-keyword">if</span> (url === <span class="hljs-string">''</span> || !url) {
    res.status(<span class="hljs-number">400</span>).json([{msg: <span class="hljs-string">'Url for reset password link is not specified'</span>, param: <span class="hljs-string">'url'</span>}]);
    <span class="hljs-keyword">return</span>;
  }
  User.findOne({email: email}, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, user</span>) </span>{
    <span class="hljs-keyword">if</span> (!user) {</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>logger.info(‘User not found based on email for password reset. Email requested: ‘ + email);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      res.status(<span class="hljs-number">400</span>).json([{msg: <span class="hljs-string">'Email not found'</span>, param: <span class="hljs-string">'email'</span>}]);
    }
    <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Generate random password</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> resetToken = utils.randomString(<span class="hljs-number">16</span>);
      user.resetToken = resetToken;</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>Generate reset password link</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> link = url + <span class="hljs-string">'?token='</span> + resetToken;
      user.save(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) </span>{
        <span class="hljs-keyword">if</span> (err) {</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>logger.error(‘Error saving user new password’);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'error saving new user password'</span>);
        }
        <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>logger.info(‘New password generated for user id: ‘ + user._id);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          mailer.sendMessage(user, link, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, info</span>) </span>{
            <span class="hljs-keyword">if</span> (err) {</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>logger.error(‘Sending message error : ‘ + err);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              res.status(<span class="hljs-number">401</span>).json({msg: <span class="hljs-string">'error_sending_password'</span>, error: err});
            }
            <span class="hljs-keyword">else</span> {
              <span class="hljs-keyword">if</span> (process.env.ENV === <span class="hljs-string">'testing'</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Write new password to a file</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                fs.writeFileSync(<span class="hljs-string">"./testpass.txt"</span>, link);
              }</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>logger.info(‘Remind password message sent to email : ‘ + user.email);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              <span class="hljs-keyword">var</span> resp = {};
              resp.msg = <span class="hljs-string">'new_password_sent'</span>;
              res.status(<span class="hljs-number">200</span>).json(resp);
            }
          });
        }
      });
    }
  });
};

UserController.prototype.resetPassword = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, res, next</span>) </span>{
  <span class="hljs-keyword">var</span> token = req.body.token;
  <span class="hljs-keyword">var</span> password = req.body.password;

  <span class="hljs-keyword">if</span> (token === <span class="hljs-string">''</span> || password === <span class="hljs-string">''</span>) {
    res.status(<span class="hljs-number">400</span>).send(<span class="hljs-string">'Token or password not provided'</span>);
    <span class="hljs-keyword">return</span>;
  }
  User.findOne({resetToken: token}, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, user</span>) </span>{
    <span class="hljs-keyword">if</span> (!user) {</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>logger.error(‘User not found resetToken: ‘ + token);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      res.status(<span class="hljs-number">400</span>).send(<span class="hljs-string">'User not found'</span>);
    }
    <span class="hljs-keyword">else</span> {
      user.resetToken = <span class="hljs-string">''</span>;
      user.password = password;
      user.save(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) </span>{
        <span class="hljs-keyword">if</span> (err) {</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>logger.error(‘Error saving reset password’);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        }
        <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>logger.info(‘Reset password by user with id: ‘ + user._id);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          res.json({msg: <span class="hljs-string">'New password set'</span>});
        }
      });
    }
  });
};

UserController.prototype.authorize = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, res, next</span>) </span>{
  <span class="hljs-keyword">if</span> (!req.headers.authorization) {
    <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">401</span>).send({ message: <span class="hljs-string">'Please make sure your request has an Authorization header'</span> });
  }
  <span class="hljs-keyword">var</span> token = req.headers.authorization.split(<span class="hljs-string">' '</span>)[<span class="hljs-number">1</span>];

  <span class="hljs-keyword">var</span> payload = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">try</span> {
    payload = jwt.decode(token, tokenSecret);
  }
  <span class="hljs-keyword">catch</span> (err) {
    <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">401</span>).send({ message: err.message });
  }

  <span class="hljs-keyword">if</span> (payload.exp &lt;= moment().unix()) {
    <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">401</span>).send({ message: <span class="hljs-string">'Token has expired'</span> });
  }
  req.user = payload.user;
  next();
}

UserController.prototype.keepAlive = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, res, next</span>) </span>{
  <span class="hljs-keyword">var</span> token = getToken(req);
  <span class="hljs-keyword">try</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>@TODO code duplication</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> decoded = jwt.decode(token, tokenSecret);
    <span class="hljs-keyword">var</span> diff = <span class="hljs-built_in">parseInt</span>((<span class="hljs-built_in">Date</span>.now() - decoded.iat) / <span class="hljs-number">1000</span>, <span class="hljs-number">10</span>);
    <span class="hljs-keyword">if</span> (nconf.get(<span class="hljs-string">'tokenExpire'</span>) &lt; diff) {
        res.send(<span class="hljs-number">401</span>, <span class="hljs-string">'Access token has expired'</span>);
      }
    <span class="hljs-keyword">else</span> {
      User.findOne({_id: decoded.user._id}, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, user</span>) </span>{
        <span class="hljs-keyword">if</span> (err || !user) {</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>logger.error(‘KeepAlive, issue generating token for user id : ‘ + decoded.user._id);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          res.status(<span class="hljs-number">400</span>).json({error: <span class="hljs-string">'Issue generating token'</span>});
        }
        <span class="hljs-keyword">else</span> {
          res.json({token: createJWT(user)});
        }
      });
    }
  }
  <span class="hljs-keyword">catch</span> (e) {</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>logger.error(‘KeepAlive error: decoding token failed.’);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    res.status(<span class="hljs-number">400</span>).send(<span class="hljs-string">'Unauthorized'</span>);
  }
}</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>Adds or updates a users card.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
UserController.prototype.postBilling = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res, next</span>)</span>{
  <span class="hljs-keyword">var</span> stripeToken = req.body.stripeToken;

  <span class="hljs-keyword">if</span>(!stripeToken){</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>req.flash(‘errors’, { msg: ‘Please provide a valid card.’ });
////console.log(‘no stripe token’)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">return</span> res.json(<span class="hljs-number">405</span>);      
  }

  User.findById(req.user._id, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, user</span>) </span>{
    <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">return</span> next(err);

    user.setCard(stripeToken, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) </span>{
      <span class="hljs-keyword">if</span> (err) {
        <span class="hljs-keyword">if</span>(err.code &amp;&amp; err.code == <span class="hljs-string">'card_declined'</span>){</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>req.flash(‘errors’, { msg: ‘Your card was declined. Please provide a valid card.’ });
////console.log(‘card declined’);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          res.json(<span class="hljs-number">400</span>);                
          <span class="hljs-keyword">return</span>;
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>req.flash(‘errors’, { msg: ‘An unexpected error occurred.’ });
////console.log(‘error occured’);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        res.json(<span class="hljs-number">403</span>);      
        <span class="hljs-keyword">return</span>;
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>req.flash(‘success’, { msg: ‘Billing has been updated.’ });
////console.log(‘card updated’);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      res.json(<span class="hljs-number">200</span>);      
      <span class="hljs-keyword">return</span>;
    });
  });
};

UserController.prototype.postPlan = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res, next</span>)</span>{
  <span class="hljs-keyword">var</span> _plan = req.body.plan;
  <span class="hljs-keyword">var</span> stripeToken = <span class="hljs-literal">null</span>;

  <span class="hljs-keyword">if</span>(_plan){
    _plan = _plan.toLowerCase();
  }
  <span class="hljs-keyword">if</span>(req.body.user.stripe.plan == _plan){</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>req.flash(‘info’, {msg: ‘The selected plan is the same as the current plan.’});
return res.redirect(req.redirect.success);
////console.log(‘plan is the same as current’);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    res.json({status:<span class="hljs-number">400</span>, msg:<span class="hljs-string">'Same plan'</span>});    
    <span class="hljs-keyword">return</span>;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>if(req.body.stripeToken){
  stripeToken = req.body.stripeToken;
}</p>

            </div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>if(!req.body.user.stripe.last4 &amp;&amp; !req.body.stripeToken){
  // req.flash(‘errors’, {msg: ‘Please add a card to your account before choosing a plan.’});
  // return res.redirect(req.redirect.failure);
  ////console.log(‘please add card to account before choosing plan’);
}</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  User.findById(req.body.user._id, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, user</span>) </span>{
    <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">return</span> next(err);
    user.setPlan(_plan, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, response</span>) </span>{
      <span class="hljs-keyword">var</span> msg;
      <span class="hljs-keyword">if</span> (err) {
        <span class="hljs-keyword">if</span>(err.code &amp;&amp; err.code == <span class="hljs-string">'card_declined'</span>){
          msg = <span class="hljs-string">'Your card was declined. Please provide a valid card.'</span>;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(err &amp;&amp; err.message) {
          msg = err.message;
        } <span class="hljs-keyword">else</span> {
          msg = <span class="hljs-string">'An unexpected error occurred.'</span>;
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>////console.log(‘fail’);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        res.json({status:<span class="hljs-number">400</span>});    
        <span class="hljs-keyword">return</span>;
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>req.flash(‘success’, { msg: ‘Plan has been updated.’ });
res.redirect(req.redirect.success);
////console.log(‘plan updated’);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      res.json({status:<span class="hljs-number">200</span>, msg:response});    
      <span class="hljs-keyword">return</span>;
    });
  });
};

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getToken</span>(<span class="hljs-params">req</span>) </span>{
  <span class="hljs-keyword">if</span> (req.headers.authorization) {
    <span class="hljs-keyword">return</span> req.headers.authorization.split(<span class="hljs-string">' '</span>)[<span class="hljs-number">1</span>];
  }
  <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }
}

<span class="hljs-keyword">var</span> hat = <span class="hljs-built_in">require</span>(<span class="hljs-string">'hat'</span>);
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createApiKey</span>(<span class="hljs-params">user</span>) </span>{
  user = _.pick(user, <span class="hljs-string">'_id'</span> ,<span class="hljs-string">'email'</span>); 
  <span class="hljs-keyword">var</span> rack = hat.rack(); 
  <span class="hljs-keyword">var</span> payload = {
    user: user,
    iat: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime(),
    jti: rack(), <span class="hljs-comment">// a unique id for this token (for revocation purposes)</span>
  };
  <span class="hljs-keyword">return</span> jwt.encode(payload, tokenSecret);
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createJWT</span>(<span class="hljs-params">user, data</span>) </span>{
  user = _.pick(user, <span class="hljs-string">'_id'</span> ,<span class="hljs-string">'email'</span>);  
  <span class="hljs-keyword">var</span> payload = {
    user: user,
    data: data,
    iat: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime(),
    exp: moment().add(<span class="hljs-number">7</span>, <span class="hljs-string">'days'</span>).valueOf()
  };
  <span class="hljs-keyword">return</span> jwt.encode(payload, tokenSecret);
}

<span class="hljs-built_in">module</span>.exports = <span class="hljs-keyword">new</span> UserController();</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
